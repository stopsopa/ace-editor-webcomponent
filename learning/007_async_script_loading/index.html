<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>007 - Async Script Loading with Web Components</title>

    
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: 50px auto;
        padding: 0 20px;
        line-height: 1.6;
      }
      h1 {
        color: #333;
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
      }
      h2 {
        color: #667eea;
        margin-top: 30px;
      }
      code {
        background: #f4f4f4;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: "Courier New", monospace;
      }
      pre {
        background: #f4f4f4;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
      }
      .example {
        border: 2px solid #333;
        padding: 20px;
        margin: 20px 0;
        border-radius: 5px;
        background: #fff;
      }
      a {
        color: #0066cc;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 5px;
        font-weight: bold;
      }
      button:hover {
        background: #764ba2;
      }
      .component-wrapper {
        border: 2px solid #e0e0e0;
        padding: 15px;
        margin: 15px 0;
        border-radius: 8px;
        background: #f9f9f9;
      }
      .component-wrapper h4 {
        margin: 0 0 10px 0;
        color: #667eea;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .remove-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 5px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      .remove-btn:hover {
        background: #c82333;
      }
      .info-box {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
      }
      .info-box strong {
        color: #1976d2;
      }
    </style>
  </head>
  <body>
    <h1>Lesson 007: Async Script Loading with Web Components</h1>

    <p>
      <a href="../006_event_handling/">‚Üê Previous: Event Handling</a> |
      <a href="../008_ace_async_loader/">Next: Ace Async Loader ‚Üí</a>
    </p>

    <h2>What You'll Learn</h2>
    <ul>
      <li>Load external ESM modules dynamically</li>
      <li>Singleton pattern for loading scripts once</li>
      <li>Handle components declared in HTML before script loads</li>
      <li>Support dynamically adding components after script loads</li>
      <li>Proper lifecycle management with external dependencies</li>
    </ul>

    <h2>The Challenge</h2>
    <p>Web components often depend on external libraries. The challenge is:</p>
    <ul>
      <li>‚úÖ Load the external library only <strong>once</strong></li>
      <li>
        ‚úÖ Support components declared in initial HTML (before library loads)
      </li>
      <li>‚úÖ Support dynamically added components (after library loads)</li>
      <li>‚úÖ Initialize all waiting components once library is ready</li>
      <li>‚úÖ Don't block page rendering</li>
    </ul>

    <div class="info-box">
      <strong>üì∫ Open DevTools Network Tab:</strong> Watch how
      <code>myToolESM.js</code> loads only ONCE, no matter how many
      <code>&lt;my-tool&gt;</code> components you have!
    </div>

    <h2>Live Example</h2>
    <div class="example">
      <h3>Step 1: Load the Component Module</h3>
      <p>
        <strong
          >Click buttons to dynamically load script and add components:</strong
        >
      </p>
      <div>
        <button onclick="loadComponentScript()" id="load-script-btn">
          Load my-tool-esm.js
        </button>
        <button onclick="addNewComponent()">Add New Component</button>
      </div>
      <div
        id="script-status"
        style="
          margin-top: 10px;
          padding: 10px;
          background: #fff3cd;
          border-radius: 5px;
        "
      >
        Status: Component script not loaded yet
      </div>

      <!-- These components are declared BEFORE the script loads! -->
      <div class="component-wrapper" id="wrapper-tool-1">
        <h4>
          <span>Component #1 (static)</span>
          <button class="remove-btn" onclick="removeComponent('wrapper-tool-1', 'tool-1')">Remove</button>
        </h4>
        <my-tool id="tool-1"></my-tool>
      </div>

      <div class="component-wrapper" id="wrapper-tool-2">
        <h4>
          <span>Component #2 (static)</span>
          <button class="remove-btn" onclick="removeComponent('wrapper-tool-2', 'tool-2')">Remove</button>
        </h4>
        <my-tool id="tool-2"></my-tool>
      </div>

      <div id="dynamic-components"></div>
    </div>

    <h2>How It Works</h2>
    <ol>
      <li>
        <strong>Dynamic Script Loading:</strong> Button creates and injects
        <code>&lt;script&gt;</code> tag on demand
      </li>
      <li>
        <strong>Auto Registration:</strong> The module registers the
        <code>&lt;my-tool&gt;</code> custom element
      </li>
      <li>
        <strong>Lazy Loading:</strong> External dependency (myToolESM.js) loads
        only when first component connects
      </li>
      <li>
        <strong>Singleton Pattern:</strong> Even with multiple components,
        dependency loads only once
      </li>
      <li>
        <strong>Works Everywhere:</strong> Components declared in HTML or added
        dynamically both work!
      </li>
    </ol>

    <h2>Key Concepts</h2>
    <ul>
      <li>
        <strong>On-Demand Loading:</strong> Script loads only when needed
        (button click)
      </li>
      <li>
        <strong>Singleton Loading:</strong> External dependency loads only once
      </li>
      <li>
        <strong>Declarative HTML:</strong> Components can be declared before
        script loads
      </li>
      <li>
        <strong>No Manual Init:</strong> Components automatically initialize
        when script registers them
      </li>
      <li><strong>Shadow DOM:</strong> Each component has isolated styles</li>
    </ul>

    <h2>Why This Pattern?</h2>
    <ul>
      <li>‚úÖ <strong>Simple:</strong> One script, use anywhere</li>
      <li>
        ‚úÖ <strong>Performance:</strong> Load script only when needed, external
        module loads once
      </li>
      <li>
        ‚úÖ <strong>Flexible:</strong> Works with static and dynamic components
      </li>
      <li>
        ‚úÖ <strong>Clean:</strong> No global variables or manual coordination
      </li>
      <li>
        ‚úÖ <strong>Real-world:</strong> This is how you'll build the Ace Editor
        component!
      </li>
    </ul>

    <h2>Further Reading</h2>
    <ul>
      <li>
        <a
          href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/import"
          target="_blank"
          >MDN: Dynamic import()</a
        >
      </li>
      <li>
        <a
          href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise"
          target="_blank"
          >MDN: Promise</a
        >
      </li>
      <li>
        <a
          href="https://developer.mozilla.org/en-US/docs/Web/API/CustomElementRegistry/define"
          target="_blank"
          >MDN: customElements.define()</a
        >
      </li>
    </ul>

    <p>
      <a href="../006_event_handling/">‚Üê Previous: Event Handling</a> |
      <a href="../008_ace_async_loader/">Next: Ace Async Loader ‚Üí</a>
    </p>

    <!-- Simple script for dynamic component addition and script loading -->
    <script type="module">
      let componentCounter = 3; // We already have 3 static components

      // Function to dynamically load the component script
      window.loadComponentScript = async function () {
        const statusEl = document.getElementById("script-status");
        const btnEl = document.getElementById("load-script-btn");

        try {
          statusEl.textContent = "Status: Loading my-tool-esm.js...";
          statusEl.style.background = "#fff3cd";

          console.log(
            "üì¶ Dynamically creating <script> tag for my-tool-esm.js..."
          );

          // Create script tag dynamically
          const script = document.createElement("script");
          script.type = "module";
          script.src = "./my-tool-esm.js?delay=1000";

          // Wait for script to load
          await new Promise((resolve, reject) => {
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });

          statusEl.textContent =
            "Status: ‚úÖ my-tool-esm.js loaded! Components are now alive!";
          statusEl.style.background = "#d4edda";

          // Replace button with success message
          btnEl.outerHTML =
            '<div style="padding: 10px 20px; background: #d4edda; color: #155724; border-radius: 5px; font-weight: bold; text-align: center;">‚úÖ Script Loaded Successfully</div>';

          console.log("‚úÖ my-tool-esm.js loaded successfully!");
          console.log(
            "‚úÖ All <my-tool> components in the DOM are now initializing!"
          );
        } catch (error) {
          console.error("‚ùå Failed to load script:", error);
          statusEl.textContent = "Status: ‚ùå Failed to load script!";
          statusEl.style.background = "#f8d7da";
        }
      };

      window.removeComponent = function (wrapperId, componentId) {
        const wrapper = document.getElementById(wrapperId);
        if (wrapper) {
          wrapper.remove();
          console.log(`üóëÔ∏è Component removed: ${componentId}`);
        }
      };

      window.addNewComponent = function () {
        componentCounter++;
        const wrapperId = `wrapper-tool-${componentCounter}`;
        const componentId = `tool-${componentCounter}`;

        const wrapper = document.createElement("div");
        wrapper.className = "component-wrapper";
        wrapper.id = wrapperId;

        const heading = document.createElement("h4");
        const span = document.createElement("span");
        span.textContent = `Component #${componentCounter} (dynamic)`;

        const removeBtn = document.createElement("button");
        removeBtn.className = "remove-btn";
        removeBtn.textContent = "Remove";
        removeBtn.onclick = () => removeComponent(wrapperId, componentId);

        heading.appendChild(span);
        heading.appendChild(removeBtn);

        const component = document.createElement("my-tool");
        component.id = componentId;

        wrapper.appendChild(heading);
        wrapper.appendChild(component);

        document.getElementById("dynamic-components").appendChild(wrapper);

        console.log(`‚ûï Dynamic component added: ${componentId}`);
      };

      console.log("üí° Instructions:");
      console.log("1. Open DevTools Network tab");
      console.log("2. Click 'Load my-tool-esm.js' button");
      console.log("3. Watch my-tool-esm.js load");
      console.log("4. Watch myToolESM.js (dependency) load only ONCE");
      console.log("5. All 3 static <my-tool> components spring to life!");
      console.log("6. Click 'Add New Component' - components work instantly!");
    </script>
  </body>
</html>
